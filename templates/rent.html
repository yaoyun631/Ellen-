{% extends "base.html" %}
{% block title %}Ellenç§Ÿå±‹å°ˆå€{% endblock %}
{% block content %}

<div class="container mt-4">

  <!-- æŸ¥è©¢è¡¨å–® -->
  <div class="p-4 mb-5" style="background-color: #CABAA1; border: 1px solid #eee; border-radius: 8px;">
    <h2 class="mb-4 d-flex align-items-center justify-content-between">
      <span>ğŸ å°ä¸­ç§Ÿå±‹</span>
      <span>
        <a href="{{ url_for('index') }}" class="btn btn-sm btn-primary me-2">æ‰¾å¥½æˆ¿</a>
        <a href="{{ url_for('rent') }}" class="btn btn-sm btn-success">ç§Ÿå¥½å±‹</a>
      </span>
    </h2>

    <form method="GET" id="rentSearchForm">
      <div class="row g-3">

        <!-- å€åŸŸ -->
        <div class="col-12">
          <label class="form-label">å€åŸŸ</label><br />
          <label class="me-3"><input type="checkbox" id="area_all" onchange="toggleAll(this)"> å…¨éƒ¨</label>
          {% for d in taichung_districts %}
          <label class="me-3">
            <input type="checkbox" name="areas" value="{{ d }}" {% if d in selected_areas %}checked{% endif %}> {{ d.replace('å°ä¸­å¸‚', '') }}
          </label>
          {% endfor %}
        </div>

        <!-- æˆ¿å±‹å½¢å¼ -->
        <div class="col-12 mt-3">
          <label class="form-label">æˆ¿å±‹å½¢å¼</label><br />
          {% set house_forms = ["æ•´å±¤ä½å®¶", "ç¨ç«‹å¥—æˆ¿", "åˆ†ç§Ÿå¥—æˆ¿", "é›…æˆ¿", "åº—é¢", "å•†è¾¦", "å» æˆ¿", "åœŸåœ°"] %}
          {% for f in house_forms %}
          <label class="me-2">
            <input type="checkbox" name="house_forms" value="{{ f }}" {% if f in selected_house_forms %}checked{% endif %}> {{ f }}
          </label>
          {% endfor %}
        </div>

        <!-- æˆ¿å±‹é¡å‹ -->
        <div class="col-12 mt-3">
          <label class="form-label">æˆ¿å±‹é¡å‹</label><br />
          {% set house_types = ["é€å¤©", "åˆ¥å¢…", "è¯å»ˆ", "å…¬å¯“", "é›»æ¢¯å¤§æ¨“", "å…¶ä»–"] %}
          {% for t in house_types %}
          <label class="me-2">
            <input type="checkbox" name="house_types" value="{{ t }}" {% if t in selected_house_types %}checked{% endif %}> {{ t }}
          </label>
          {% endfor %}
        </div>

        <!-- ğŸŒŸ ç‰¹è‰² -->
        <div class="col-12 mt-3">
          <label class="form-label fw-bold">ç‰¹è‰²</label><br />
          <div class="d-flex flex-wrap align-items-center">
            <!-- å¯å¯µç‰© -->
            <div class="me-4 mb-2">
              <label>
                <input type="checkbox" name="pets" value="2" {% if '2' in selected_pets %}checked{% endif %}> å¯å¯µç‰©
              </label>
            </div>
            <!-- æœ‰é™½å° -->
            <div class="me-4 mb-2">
              <label>
                <input type="checkbox" name="has_balcony" value="1" {% if selected_has_balcony %}checked{% endif %}> æœ‰é™½å°
              </label>
            </div>
            <!-- æœ‰è»Šä½ -->
            <div class="me-4 mb-2">
              <label>
                <input type="checkbox" name="has_parking" value="1" {% if selected_has_parking %}checked{% endif %}> æœ‰è»Šä½
              </label>
            </div>
            <!-- æœ‰é£²æ°´æ©Ÿ -->
            <div class="me-4 mb-2">
              <label>
                <input type="checkbox" name="has_water_cooler" value="1" {% if selected_has_water_cooler %}checked{% endif %}> æœ‰é£²æ°´æ©Ÿ
              </label>
            </div>
            <!-- æœ‰å­æ¯è»Š -->
            <div class="me-4 mb-2">
              <label>
                <input type="checkbox" name="has_wheelie_bin" value="1" {% if selected_has_wheelie_bin %}checked{% endif %}> æœ‰å­æ¯è»Š
              </label>
            </div>
            <!-- æœ‰æµç†å° -->
            <div class="me-4 mb-2">
              <label>
                <input type="checkbox" name="has_sink" value="1" {% if selected_has_sink %}checked{% endif %}> æœ‰æµç†å°
              </label>
            </div>
            <!-- è¡›æµ´ä¹¾æ¿•åˆ†é›¢ -->
            <div class="me-4 mb-2">
              <label>
                <input type="checkbox" name="has_bath_separate" value="1" {% if selected_has_bath_separate %}checked{% endif %}> è¡›æµ´ä¹¾æ¿•åˆ†é›¢
              </label>
            </div>
            <!-- ç¨ç«‹æ´—è¡£æ©Ÿ -->
            <div class="me-4 mb-2">
              <label>
                <input type="checkbox" name="has_washer_indep" value="1" {% if selected_has_washer_indep %}checked{% endif %}> ç¨ç«‹æ´—è¡£æ©Ÿ
              </label>
            </div>
          </div>
        </div>

        <!-- æ ¼å±€ -->
        <div class="col-6 col-md-2">
          <label for="room_min" class="form-label">æ ¼å±€æœ€å°(æˆ¿)</label>
          <input type="text" name="room_min" id="room_min" class="form-control" pattern="\d*" inputmode="numeric" value="{{ room_min }}">
        </div>
        <div class="col-6 col-md-2">
          <label for="room_max" class="form-label">æ ¼å±€æœ€å¤§(æˆ¿)</label>
          <input type="text" name="room_max" id="room_max" class="form-control" pattern="\d*" inputmode="numeric" value="{{ room_max }}">
        </div>

        <!-- ç§Ÿé‡‘ -->
        <div class="col-6 col-md-2">
          <label for="price_min" class="form-label">ç§Ÿé‡‘æœ€å°(å…ƒ)</label>
          <input type="text" name="price_min" id="price_min" class="form-control" pattern="\d*" inputmode="numeric" value="{{ price_min }}">
        </div>
        <div class="col-6 col-md-2">
          <label for="price_max" class="form-label">ç§Ÿé‡‘æœ€å¤§(å…ƒ)</label>
          <input type="text" name="price_max" id="price_max" class="form-control" pattern="\d*" inputmode="numeric" value="{{ price_max }}">
        </div>

        <!-- é—œéµå­— -->
        <div class="col-12 col-md-6">
          <label for="keyword" class="form-label">é—œéµå­—ï¼ˆåœ°å€ã€æè¿°ï¼‰</label>
          <input type="text" name="keyword" id="keyword" class="form-control" value="{{ keyword }}">
        </div>

        <!-- æ’åºé¸å–®æ”¾åœ¨é—œéµå­—æ—é‚Š -->
        <div class="col-12 col-md-6">
          <label for="sort_by" class="form-label fw-bold">æ’åºæ–¹å¼</label>
          <select name="sort_by" id="sort_by" class="form-select">
            <option value="" {% if not sort_by %}selected{% endif %}>ç„¡æ’åº</option>
            <option value="price_asc" {% if sort_by == 'price_asc' %}selected{% endif %}>ç§Ÿé‡‘ç”±å°åˆ°å¤§</option>
            <option value="price_desc" {% if sort_by == 'price_desc' %}selected{% endif %}>ç§Ÿé‡‘ç”±å¤§åˆ°å°</option>
            <option value="room_asc" {% if sort_by == 'room_asc' %}selected{% endif %}>æ ¼å±€ç”±å°‘åˆ°å¤š</option>
            <option value="room_desc" {% if sort_by == 'room_desc' %}selected{% endif %}>æ ¼å±€ç”±å¤šåˆ°å°‘</option>
          </select>
        </div>

        <!-- æŸ¥è©¢æŒ‰éˆ• -->
        <div class="col-12 text-center">
          <button type="submit" class="btn mt-3" style="background-color: #fa782a; color: white;">
            æŸ¥è©¢
          </button>
        </div>

      </div>
    </form>
  </div>

  <!-- é¡¯ç¤ºç¬¦åˆè³‡æ–™ç­†æ•¸ -->
  <p>ç¬¦åˆæ¢ä»¶è³‡æ–™ç­†æ•¸ï¼š{{ total_records }}</p>

  <!-- ç§Ÿå±‹åˆ—è¡¨ -->
  <div class="row row-cols-1 row-cols-md-3 g-4">
    {% for row in data %}
    <div class="col">
      <a href="{{ url_for('edm', house_id=row['ç‰©ä»¶ç·¨è™Ÿ']) }}" target="_blank" rel="noopener noreferrer" class="text-decoration-none text-dark">
        <div class="card h-100 shadow-sm">
          <!-- âœ… æ–°å¢åœ–ç‰‡é¡¯ç¤ºå€å¡Š -->
          {% set first_image = (row['åœ–ç‰‡é€£çµ'].split(',')[0].strip()) if row['åœ–ç‰‡é€£çµ'] else '' %}

          {% if first_image.startswith('http') %}
            <img src="{{ first_image }}" class="card-img-top" style="height: 200px; object-fit: cover;">
          {% else %}
            <div class="d-flex align-items-center justify-content-center bg-light" style="height: 200px;">
              <span class="text-muted">åœ–ç‰‡æ–°å¢ä¸­</span>
            </div>
          {% endif %}

          <!-- å¡ç‰‡å…§å®¹ -->
          <div class="card-body">
            <h5 class="card-title">{{ row['title'] }}</h5>
            <p class="card-text text-muted">
              å€åŸŸï¼š{{ row['district'] }}<br>
              æ ¼å±€ï¼š{{ row['æ ¼å±€'] }} ï½œ å¯µç‰©ï¼š{{ row['æ˜¯å¦å¯å¯µç‰©'] or '-' }}<br>
              æ°´è²»:{{ row['æ°´è²»'] }}ï½œé›»è²»:{{ row['é›»è²»'] }}<br>
              è¨­å‚™ï¼š{{ row['è¨­å‚™'] or '-' }}
            </p>
          </div>
          <div class="card-footer text-end">
            <strong class="text-danger" style="font-size: 1.2rem;">
              {{ row['ç§Ÿé‡‘'] }}
              {% if row['ç§Ÿé‡‘'] != 'åƒ¹æ ¼æ´½è©¢' %} å…ƒ/æœˆ{% endif %}
            </strong>
          </div>
        </div>
      </a>
    </div>
    {% endfor %}
  </div>

</div>

<script>
  function toggleAll(source) {
    document.querySelectorAll('input[name="areas"]').forEach(cb => cb.checked = source.checked);
  }
</script>

{% endblock %}
